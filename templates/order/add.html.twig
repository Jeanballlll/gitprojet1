{% extends 'base.html.twig' %}

{% block javascript %}
<script src="http:://js.stripe.com/v3"></script>
{% endblock %}

{% block title %}Paiement de ma commande - Projet1
{% endblock %}

{% block content %}
	<h2>Mon Récapitulatif<h2>
			<p>Vérifiez vos informations de payer votre commande.</p>
			<hr>
			<div class="row">
				<div class="col-md-6">
					<strong>Mon adresse de livraison</strong><br/>
					<div class="form-check mt-4">
						{{ delivery|raw }}
						{# |raw c'est pour ne pas afficher les balises sur le web  #}
					</div>
					<hr>
					<strong>Mon transporteur</strong>
					<div class="form-check">
						{{ carrier.name }}<br/>
						{{ carrier.description }}<br/>
						{{ carrier.price|number_format(2) }}
						€
					</div>
				</div>
				<div class="col-md-6">
					<div class="text-center">
						<b>Ma commande(s)</b><br/>
					</div>
					<div class="order-sumary">
						{% set total = null %}
						{% for key,product in cart %}
							<div class="row {% if key > 0 %}mt-2 {% endif %}">
								<div class="col-2">
									<img src="/uploads/{{ product.product.illustration }}" alt="{{ product.product.name }}" width="75px">
								</div>
								<div class="col-8 my-auto">
									{{ product.product.name }}<br/>
									<small>{{ product.product.subtitle }}
										<br/>
										x{{ product.quantity }}</small>
								</div>
								<div class="col-2 my-auto">
									{{ (product.product.price * product.quantity /100)|number_format(2) }}€
								</div>
							</div>
							{% set total = total + (product.product.price * product.quantity)  %}
						{% endfor %}
					</div>
					<hr>
					<strong>Sous-Total :</strong>
					{{ (total / 100)|number_format(2) }}
					€<br/>
					<strong>Livraison :</strong>
					{{ (carrier.price)|number_format(2) }}
					€
					<hr>
					<strong>Total :</strong>
					{{ ((total / 100) + carrier.price)|number_format(2) }}
					€

					<a href="{{ path('app_stripe_create_session', {'reference':reference} ) }}" class="btn btn-success btn-block mt-3 mb-5" id="checkout-button">Payer | {{ ((total / 100) + carrier.price) | number_format(2, ',', '.') }} €</a>
					</div>
				</div>
			{% endblock %}

{% block script %}

<script type="text/javascript">

 var stripe = Stripe['sk_test_51Kij3tHspDAIhxScl6ZeIwNRiy66LkLezfeCtzznb3uuMjuQHJK8UxGrDSwMkDuzJ0HqrD1aiGlAYaImT25BdrCf00tfIWIOdG'];
        var checkoutButton = document.getElementById("checkout-button");
        checkoutButton.addEventListener("click", function () {
            fetch("/commande/create-session/{{ reference }}", {
                method: "POST",
            })
                .then(function (response) {
                    return response.json();
                })
                 .then(function (session) {
					 if (session.error == 'order') {
						// redirection vers adresse de livraison et de transporteur si il y a eu un probleme avec la commande
						window.location.replace('{{ path('app_order') }}');

					 } else {
						return stripe.redirectToCheckout({ sessionId: session.id});
					 }
                     
                 })
                 .then(function (result) {
 
 
                     if (result.error) {
                         alert(result.error.message);
                     }
                 })
                  .catch(function (error) {
                      console.error("Error", error);
                  })
        })
 
    </script>

{% endblock %}
